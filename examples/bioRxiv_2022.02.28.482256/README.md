## Codes for Hagen et al. 2022

These codes correspond to the preprint



### Running

Make sure that requirements are met. Then:

    cd mod
    nrnivmodl
    cd -

    $ python run_pscan.py
    $ python run_hay_pscan.py


Docker things:

    # build image using Docker:
    $ docker build -t lfpykernels - < Dockerfile

    # start container mounting local file system, open a jupyter-notebook session:
    $ docker run --mount type=bind,source="$(pwd)",target=/opt/data -it -p 5000:5000 lfpykernels
    $ cd /opt/data/
    $ jupyter-notebook --ip 0.0.0.0 --port=5000 --no-browser --allow-root

    # oneliner (open URL, then browse to `/opt/data/` and open notebooks):
    docker run --mount type=bind,source="$(pwd)",target=/opt/data -it -p 5000:5000 lfpykernels jupyter-notebook --ip 0.0.0.0 --port=5000 --no-browser --allow-root


Singularity things (see https://apps.fz-juelich.de/jsc/hps/jusuf/cluster/container-runtime.html):

    $ module --force purge
    $ module load Stages/2022 GCCcore/.11.2.0 Singularity-Tools/2022
    $ module load Singularity-Tools/2022
    $ sib upload ./Dockerfile lfpykernels
    $ sib build --recipe-name lfpykernels --blocking  # this will take a few minutes
    $ sib download --recipe-name lfpykernels

    # add to job scripts
    $ unset DISPLAY
    $ export SINGULARITYENV_PYTHONPATH=/opt/nest/lib/python3.9/site-packages
    $ cd mod && rm -rf x86_64 && singularity exec ../lfpykernels.sif nrnivmodl && cd ..  # compile NMODL files for the container
    $ srun --mpi=pmi2 singularity exec lfpykernels.sif python3 -u example_network.py 72d90a2e763ba9c3a9d85a4a715ec04c


    module --force purge
    module load Stages/2022
    module load GCC Singularity-Tools
    unset DISPLAY  # matplotlib may look for a nonexistant display on compute node(s)
    export SINGULARITYENV_SCRATCH=  # make container unaware of $SCRATCH area as we are already there - write sim output to simulation script folder
    export SINGULARITYENV_PYTHONPATH=/opt/nest/lib/python3.9/site-packages
    cd hybridLFPy/examples  # go to examples
    srun --mpi=pmi2 singularity exec lfpykernels.sif python3 -u example_microcircuit.py  # execute simulation


Scripts:

    - `run_pscan.py`: main script that submit SLURM jobs for all ball-n-sticks network simulations and hybrid scheme approximations. Adapt as necessary for the HPC resource in question.
    - `run_hay2011_pscan.py`: Similar to `run_pscan.py` but for simulation runs using the Hay et al. 2011 L5bPC model.
    - `example_network_methods.py`: module with some shared methods required by simulation scripts and analysis notebooks
    - `*_network_parameters.py`: shared parameters for the ball-n-sticks or hay2011 based networks
    - `*_network.py`: main ball-and-sticks network simulation script
    - `*_network_reconstruction.py`: hybrid-scheme implementation of extracellular signal predictions from spike output of `example_network.py`
    - `*_network_kernel.py`: hybrid-scheme calculations of kernels
    - `plotting.py`: some shared plotting routines
    - `FIR_filter.nestml`: NESTML implementation of FIR filter node
    - `L5bPCmodelsEH/`:
    - `mod/*.mod`: NMODL language files with quasi-linear and passive-frozen versions of active ion channels of the Hay et al. (2011) L5bPC model
    - `BallAndSticks*.hoc`: cell geometry/template files in NEURON's HOC language
    - `Fit_LIF_net.py`: script for fitting parameters of spiking point-neuron network
    - `Fit_LIF_net.job`: Slurm job script for `Fit_LIF_net.py`
    - `LICENSE`: Terms of use
    - `README.md`: This file

Output:

    - `jobs/*.job`: Slurm job scripts generated by `run*pscan.py` script
    - `output/*/*`: File output by different simulation scripts
    - `logs/*.txt`: Job output to STDOUT/STDERR
    - `parameters/*.txt`: parameter dictionary files generated by `run*pscan.py` scripts
    - `PS*.txt`: `parameters.ParameterSpace` files for the different simulations started by `run_pscan.py`
    - `hay2011_PS*.txt`: `parameters.ParameterSpace` files for the different simulations started by `run_hay2011_pscan.py`
    - `Fit_LIF_net.h5`: file output created by successful runs of `Fit_LIF_net.py`

Notebooks:

   - `Figure*.ipynb`: Jupyter notebooks used to generate the corresponding figures post simulation plus some analysis
